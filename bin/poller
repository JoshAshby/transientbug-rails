#!/usr/bin/env ruby
begin
  load File.expand_path('../spring', __FILE__)
rescue LoadError => e
  raise unless e.message.include?('spring')
end

APP_PATH = File.expand_path('../config/application', __dir__)

require_relative '../config/boot'
require_relative '../config/environment'

bots_to_check = AutumnMoon.bots.each_with_object({}) do |(token, bot), memo|
  client = AutumnMoon::TelegramClient.new token: token

  next unless client.get_webhook_info[:url].empty?

  memo[ client ] = bot
end


loop do
  bots_to_check.each do |client, data|
    msg = client.get_updates.last

    next unless msg
    next if Redis.current.get msg[:update_id]

    Redis.current.setex msg[:update_id], 1800, true

    HTTP.post "http://localhost:3000/telegram/#{ client.token }", json: msg
  end

  sleep 5
end
