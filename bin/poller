#!/usr/bin/env ruby
begin
  load File.expand_path('../spring', __FILE__)
rescue LoadError => e
  raise unless e.message.include?('spring')
end

APP_PATH = File.expand_path('../config/application', __dir__)

require_relative '../config/boot'
require_relative '../config/environment'

loop do
  AutumnMoon.bots.each do |id, bot|
    msg = bot.client.get_updates.last

    next unless msg
    next if Redis.current.get msg[:update_id]

    Redis.current.setex msg[:update_id], 1800, true

    HTTP.post "http://localhost:3000/telegram/#{ id }", json: msg
  end

  sleep 5
end
